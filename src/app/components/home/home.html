@if (!isClientCredentialsValid()) {
<div class="login" [formGroup]="form">
    <div class="credentials">
        <p-floatlabel variant="on">
            <input pInputText id="clientId" formControlName="clientId" autocomplete="off" />
            <label for="clientId">Client id</label>
        </p-floatlabel>

        <p-floatlabel variant="on">
            <input pInputText id="clientSecret" formControlName="clientSecret" autocomplete="off" />
            <label for="clientSecret">Client secret</label>
        </p-floatlabel>
        <button pButton type="button" label="Connect" (click)="login()" [disabled]="form.invalid"></button>
    </div>
    <small class="credentials-hint">
        Vous pouvez obtenir votre <strong>Client ID</strong> et <strong>Client Secret</strong> en vous rendant sur
        <a [href]="soundcloudAppsUrl" (click)="$event.preventDefault(); openSoundcloudApps()">
            {{ soundcloudAppsUrl }}
        </a>
        dans votre navigateur. <br>
        Si vous n'avez pas d'app enregistrÃ©e cliquez sur <strong>Sign up for a new app</strong> comme nom et
        description mettez: "synchroniser". <br>
        Ensuite quand l'app est crÃ©Ã©e assurez vous que le <strong>Redirect URI</strong> est bien:
        <div class="redirect-uri">
            <code>{{ callbackUri }}</code>
            <p-button icon="pi pi-copy" rounded="true" text="true" severity="secondary"
                (click)="copyRedirectUri()"></p-button>
        </div>
        et que vous avez sauvegarder.
        <br>
        Maintenant vous n'avez plus qu'a copier votre <strong>Client ID</strong> et <strong>Client Secret</strong>
        ğŸ˜‰
    </small>
</div>
} @else {
<div class="main">
    @if (isAuthenticated()) {
    <div class="playlists">
        <h3>Mes playlists</h3>
        <button class="sync-playlists" pButton label="Synchroniser" (click)="syncPlaylists()"
            [disabled]="saveDirectory() === ''"></button>

        <div class="directory-selector">
            <p-floatlabel variant="on">
                <input pInputText readonly id="playlistSearch" [ngModel]="saveDirectory()" autocomplete="off" />
                <label for="playlistSearch">Dossier de sauvegarde</label>
            </p-floatlabel>

            <button pButton label="Select Folder" icon="pi pi-folder" (click)="selectDirctory()"></button>
        </div>

        <div class="playlist-search">
            <p-floatlabel variant="on">
                <input pInputText id="playlistSearch" [ngModel]="playlistQuery()"
                    (ngModelChange)="playlistQuery.set($event)" autocomplete="off" />
                <label for="playlistSearch">Rechercher une playlist</label>
            </p-floatlabel>
        </div>

        @if (progress$ | async; as p) {
        @if (p.status !== 'idle') {
        <div class="card">
            <div class="progress-header">
                <p-progressBar [value]="getProgressPercent(p)" [showValue]="true" class="flex-1">
                </p-progressBar>
                <button pButton type="button" icon="pi pi-times"
                    class="p-button-rounded p-button-text p-button-danger close-btn" (click)="cancelSync()">
                </button>
            </div>
            <div class="sync-line mt-2">
                <span class="progress">
                    {{ p.processed }}/{{ p.total }}
                </span>
                <span class="sep">â€¢</span>
                <span>â¬‡ {{ p.downloaded }}</span>
                <span>ğŸ§ {{ p.streamed }}</span>
                <span>â­ {{ p.skipped }}</span>
                @if (p.errors > 0) {
                <span class="error">âœ— {{ p.errors }}</span>
                }
                <span class="sep">â€¢</span>
                <span>{{ p.rate || 0 }} track/s</span>
                <span class="sep">â€¢</span>
                <span>Temps restant estimÃ© : {{ formatEta(p.etaMs) }}</span>
                <span class="sep">â€¢</span>
                <span>{{ formatElapsed(p.elapsedMs) }}</span>
            </div>
        </div>
        }
        }

        @if (loadingPlaylists()) {
        <p-progress-spinner ariaLabel="loading" />
        } @else if (filteredPlaylists() && filteredPlaylists()!.length) {
        <div class="playlists-grid">
            @for (playlist of filteredPlaylists()!; track playlist.id) {
            <button type="button" class="playlist-item" [class.synced]="isSynced(playlist.id)"
                (click)="togglePlaylistSync(playlist)" [attr.aria-pressed]="isSynced(playlist.id)">

                <img class="artwork" [src]="getPlaylistArtworkUrl(playlist)" loading="lazy"
                    (error)="onPlaylistImgError($event)" />

                <div class="meta">
                    <div class="title" [title]="playlist.title">{{ playlist.title }}</div>
                    <div class="status">
                        <i class="pi" [ngClass]="isSynced(playlist.id) ? 'pi-check' : 'pi-circle'"></i>
                        <span>{{ isSynced(playlist.id) ? 'SynchronisÃ©e' : 'Non synchronisÃ©e' }}</span>
                    </div>
                </div>
            </button>
            }
        </div>
        } @else if (filteredPlaylists() && filteredPlaylists()!.length === 0) {
        <span>Aucune playlist trouvÃ©e</span>
        }
    </div>
    }
    @if (isAuthenticated() && user(); as user) {
    <div class="user-details">
        <span>
            Coucou {{ user.username }} ğŸ‘‹
        </span>
        @if (user.avatar_url) {
        <p-avatar [image]="user.avatar_url" class="mr-2" size="xlarge" shape="circle" />
        } @else {
        <p-avatar icon="pi pi-user" class="mr-2" size="xlarge" shape="circle" />
        }
    </div>
    }
</div>
}